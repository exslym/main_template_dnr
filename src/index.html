<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="shortcut icon" href="#" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<!-- Для Google Analytics:
			PROJECT_NAME - название проекта для GA, одинаковае на всех страницах многостраничного сайта; 
			PAGE_TITLE - название текущей страницы (title), если это многостраничный сайт, то на следующих страницах после главной можно указать, например, page1, page2 и т.д., -->
		<meta name="projectName" content="PROJECT_NAME" />
		<title data-title="pageTitle">PAGE_TITLE</title>
	</head>

	<body>
		<div class="wrapper">
			<section class="section _1" data-id="slidesObserver" id="slide_1">
				<div class="section__content">
					<div class="block">
						<h1>Header</h1>
						<button
							type="submit"
							data-label="button_1"
							onclick="ga(`${projectName}.send`, `event`, `button`, `click`, `${dataset.label}`); gtag('event', 'button-click', {'button': dataset.label});"
						>
							click me
						</button>
						<video controls preload="auto" data-label="background_music">
							<source
								src="../public/video/background_music.mp4"
								type="video/mp4"
							/>
						</video>
					</div>
				</div>
			</section>
		</div>

		<!-- Google Analytics (общее) -->
		<script type="text/javascript">
			const pageTitle = `${
				document.querySelector('[data-title="pageTitle"]').textContent
			}`;
			const projectName = `${
				document.querySelector('meta[name="projectName"]').content
			}`;
		</script>

		<!-- Google Analytics (GA4) -->
		<!-- 	здесь вместо X-XXXXXXXXXX - идентификатор потока данных счетчика GA4, вместо __полный_адрес_страницы__ - актуальный полный адрес (включая домен) страницы на платформе doktornarabote.ru, например: https://www.doktornarabote.ru/page/1002020
		 -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=X-XXXXXXXXXX"
		></script>
		<script type="text/javascript">
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag('js', new Date());
			gtag('config', 'X-XXXXXXXXXX');
			gtag('set', {
				page_title: `${pageTitle}`,
				page_location: `__полный_адрес_страницы__`,
			});
		</script>

		<!-- Google Analytics Universal (UA) -->
		<script type="text/javascript">
			window.addEventListener('load', function () {
				(function (i, s, o, g, r, a, m) {
					i['GoogleAnalyticsObject'] = r;
					(i[r] =
						i[r] ||
						function () {
							(i[r].q = i[r].q || []).push(arguments);
						}),
						(i[r].l = 1 * new Date());
					(a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
					a.async = 1;
					a.src = g;
					m.parentNode.insertBefore(a, m);
				})(
					window,
					document,
					'script',
					'https://www.google-analytics.com/analytics.js',
					'ga'
				);

				//! здесь вместо ___ номер счетчика UA GA
				ga(`create`, `___`, `auto`, { name: `${projectName}` });
				ga(`${projectName}.set`, `title`, `${pageTitle}`);
				//! здесь вместо page/___ - часть актуального адреса (после домена) страницы на платформе doktornarabote.ru/,  например: page/1002020
				ga(`${projectName}.set`, `page`, `page/___`);
			});
		</script>

		<!-- NoBounce (GA) -->
		<script type="text/javascript">
			window.addEventListener('load', function () {
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 5 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 5 seconds` });',
					5000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 10 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 10 seconds` });',
					10000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 15 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 15 seconds` });',
					15000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 20 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 20 seconds` });',
					20000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 30 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 30 seconds` });',
					30000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 40 seconds`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 40 seconds` });',
					40000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 1 minute`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 1 minute` });',
					60000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 2 minutes`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 2 minutes` });',
					120000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 3 minutes`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 3 minutes` });',
					180000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 5 minutes`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 5 minutes` });',
					300000
				);
				setTimeout(
					'ga(`${projectName}.send`, `event`, `NoBounce`, `Over 10 minutes`, `${pageTitle}_NoBounce`); gtag(`event`, `NoBounce`, { time: `${pageTitle}: Over 10 minutes` });',
					600000
				);
			});
		</script>

		<!-- Scroll Tracker (GA) -->
		<script type="text/javascript">
			window.addEventListener('load', event => {
				let tracker = window.ScrollTracker({
					context: document.querySelector('.wrapper'),
				});
				tracker.on({ percentages: { every: [10] } }, e => {
					ga(
						`${projectName}.send`,
						`event`,
						`scroll`,
						`${e.data.label}`,
						`${pageTitle} scrolled`
					);
				});
			});
		</script>

		<!-- Slides view (GA) -->
		<script type="text/javascript">
			window.addEventListener('load', () => {
				const slideObserver = new IntersectionObserver(
					entries => {
						entries.forEach(({ isIntersecting, target }) => {
							if (!isIntersecting) return;
							target.classList.add('_visited');
							ga(
								`${projectName}.send`,
								`event`,
								`slide`,
								`${target.id}`,
								`${pageTitle}_slides_visited`
							);
						});
					},
					{ threshold: 0.1 }
				);
				const slides = document.querySelectorAll('[data-id="slidesObserver"]');
				slides.forEach(slide => slideObserver.observe(slide));
			});
		</script>

		<!-- Videos view (GA) -->
		<script type="text/javascript">
			(function (e) {
				const matches =
					e.matches ||
					e.matchesSelector ||
					e.webkitMatchesSelector ||
					e.mozMatchesSelector ||
					e.msMatchesSelector ||
					e.oMatchesSelector;
				!matches
					? (e.matches = e.matchesSelector =
							function matches(selector) {
								const matches = document.querySelectorAll(selector);
								const th = this;
								return Array.prototype.some.call(matches, function (e) {
									return e === th;
								});
							})
					: (e.matches = e.matchesSelector = matches);
			})(Element.prototype);
			(function (e) {
				e.closest =
					e.closest ||
					function (css) {
						const node = this;
						while (node) {
							if (node.matches(css)) return node;
							else node = node.parentElement;
						}
						return null;
					};
			})(Element.prototype);
			const videos = document.querySelectorAll('video');
			videos.forEach(video => {
				let timer = null;
				let sec = 0;
				const startTimer = function startTimer() {
					return setInterval(function () {
						const seconds = sec + 1;
						const minutes = Math.floor(seconds / 60);
						const durationReal = Math.floor(video.duration);
						// Конец видео (продолжительность видео минус 5 секунд, можно задать точнее, например, за 1 секунду до конца)
						const duration = durationReal - 5;
						const data = video.dataset.label;

						// Старт видео (с 1 секунды):
						switch (true) {
							case seconds === 1:
								ga(`${projectName}.send`, `event`, `video`, `start`, data);
								break;
							case seconds > 0 && seconds < 30:
								if (seconds % 5 === 0) {
									ga(
										`${projectName}.send`,
										`event`,
										`video`,
										`${seconds}s`,
										data
									);
								}
								break;
							case seconds >= 30 && seconds < 60:
								if (seconds % 15 === 0) {
									ga(
										`${projectName}.send`,
										`event`,
										`video`,
										`${seconds}s`,
										data
									);
								}
								break;
							// после первых 60 секунд конвертим секунды в минуты и каждые 15 секунд опрокидываем событие вида, например, 1m 45s, далее 2m, далее 2m 15s и т.д.:
							case seconds >= 60 && seconds < duration:
								if (seconds % 15 === 0) {
									switch (true) {
										case seconds - minutes * 60 !== 0:
											ga(
												`${projectName}.send`,
												`event`,
												`video`,
												`${minutes}m ${seconds - minutes * 60}s`,
												data
											);
											break;
										default:
											ga(
												`${projectName}.send`,
												`event`,
												`video`,
												`${minutes}m`,
												data
											);
									}
								}
								break;
							// Конец видео:
							case seconds === duration:
								ga(`${projectName}.send`, `event`, `video`, `end`, data);
								break;
						}
						sec++;
					}, 1000);
				};
				const stopTimer = () => {
					clearInterval(timer);
				};
				video.addEventListener('play', () => {
					timer = startTimer();
				});
				video.addEventListener('pause', () => {
					stopTimer();
				});
			});
		</script>

		<script src="../tools/jquery-3.6.3.min.js"></script>
		<script src="../tools/magnific-popup.min.js"></script>
		<script src="../tools/scroll-tracker.min.js"></script>
	</body>
</html>
